name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      dome: ${{ steps.filter.outputs.dome }}
      wall: ${{ steps.filter.outputs.wall }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            dome:
              - 'services/dome/**'
            wall:
              - 'services/wall/**'

  build-dome:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.dome == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build dome
        run: |
          cd services/dome
          ./mvnw clean verify

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dome-test-results
          path: services/dome/target/surefire-reports/

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dome-coverage
          path: services/dome/target/site/jacoco/

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: services/dome/target/site/jacoco/jacoco.xml
          flags: dome
          token: ${{ secrets.CODECOV_TOKEN }}

  build-wall:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.wall == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build wall
        run: |
          cd services/wall
          ./mvnw clean verify

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wall-test-results
          path: services/wall/target/surefire-reports/

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: wall-coverage
          path: services/wall/target/site/jacoco/

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: services/wall/target/site/jacoco/jacoco.xml
          flags: wall
          token: ${{ secrets.CODECOV_TOKEN }}

  build-all:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: maven

      - name: Build all services
        run: |
          chmod +x build-all.sh
          ./build-all.sh
